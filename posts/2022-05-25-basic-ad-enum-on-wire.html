<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-12-09 Fri 00:17 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Basic Active Directory Enumeration on the Wire</title>
<meta name="author" content="Russell Brinson" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Basic Active Directory Enumeration on the Wire</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3f92649">1. Overview</a></li>
<li><a href="#org74e9bf6">2. Powershell ActiveDirectory Module</a></li>
<li><a href="#orgd3c33b4">3. C-sharp class for ActiveDirectory</a></li>
</ul>
</div>
</div>


<div id="outline-container-org3f92649" class="outline-2">
<h2 id="org3f92649"><span class="section-number-2">1.</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
I've been considering looking at the traffic of some of the active directory enumeration methods and tools generate and break it down from a basic perspective.
</p>

<p>
This lab setup was using the same setup that TCM used in the AD portion of PEH. 
</p>

<p>
When looking at the initial connections make, domain information is passed before authentication is made, allowing for tools and attackers to discern the domain name for further attacks.
</p>
</div>
</div>

<div id="outline-container-org74e9bf6" class="outline-2">
<h2 id="org74e9bf6"><span class="section-number-2">2.</span> Powershell ActiveDirectory Module</h2>
<div class="outline-text-2" id="text-2">
<p>
Had to install the Windows RSAT on the domain user I wanted to test these on.
<a href="https://www.varonis.com/blog/powershell-active-directory-module">https://www.varonis.com/blog/powershell-active-directory-module</a>
</p>

<div class="org-src-container">
<pre class="src src-powershell">import-module ActiveDIrectory
Get-ADDomain
</pre>
</div>


<div id="orga469684" class="figure">
<p><img src="../img/2022-05-Get-ADDomain.png" alt="2022-05-Get-ADDomain.png" />
</p>
</div>


<p>
<b><b>Wireshark From the ActiveDirectory module</b></b>
</p>
<pre class="example">

15	10.258916	192.168.17.145	192.168.17.144	TCP	150	57600 → 9389 [PSH, ACK] Seq=1 Ack=1 Win=8209 Len=96
16	10.259080	192.168.17.145	192.168.17.144	TCP	77	57600 → 9389 [PSH, ACK] Seq=97 Ack=1 Win=8209 Len=23
19	10.260902	192.168.17.145	192.168.17.144	TCP	59	57600 → 9389 [PSH, ACK] Seq=120 Ack=2 Win=8209 Len=5
</pre>

<p>
First thing that sticks out is <code>[PSH, ACK]</code>
According to <a href="https://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/">packetlife.net</a>, "The <code>TCP#PSH Flag</code> in the TCP header informs the receiving host that the data should be pushed up to the receiving application immediately" Meaning that it is telling the buffer of the networking device to not wait until the tcp message is full before sending it on. This was weird to me because the command has been executed and there doesn't need to be real communications. 
Until I realized that the PSH is just as much for the client as it is the server, and powershell is a good example of the server needing that to go ahead and PSH some of the received data (back from the request server). This isn't what is happening in the first few packets, just a thought on why this would be useful.
</p>


<p>
The data of the first packet has 
<code>· ···Wnet.tcp://win-o64n26d0hjt.marvel.local:9389/ActiveDirectoryWebServices/Windows/Resource··</code>
where <code>win-o64n26d0hjt</code> is just the computer name
<code>marvel.local</code> is the domain 
port? 9389
then what looks like the rest of a URI?
The second packet, continues with the data as <code>application/negotiate</code> which looks like http headers?
The rest of the packets seem to devolve into serious
</p>
</div>
</div>

<div id="outline-container-orgd3c33b4" class="outline-2">
<h2 id="orgd3c33b4"><span class="section-number-2">3.</span> C-sharp class for ActiveDirectory</h2>
<div class="outline-text-2" id="text-3">
<p>
Don't need anything other than powershell access
</p>
<div class="org-src-container">
<pre class="src src-powershell">$ADClass = [System.DirectoryServices.ActiveDirectory.Domain] $ADClass::GetCurrentDomain()
</pre>
</div>

<p>
<b><b>Wireshark From the C-sharp class</b></b>
</p>
<pre class="example">
5	22.797621	192.168.17.145	192.168.17.144	TCP	66	57855 → 389 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 WS=256 SACK_PERM=1
6	22.797782	192.168.17.144	192.168.17.145	TCP	66	389 → 57855 [SYN, ACK] Seq=0 Ack=1 Win=65535 Len=0 MSS=1460 WS=256 SACK_PERM=1
7	22.797869	192.168.17.145	192.168.17.144	TCP	54	57855 → 389 [ACK] Seq=1 Ack=1 Win=2102272 Len=0
8	22.798878	192.168.17.145	192.168.17.144	LDAP	404	searchRequest(1) "&lt;ROOT&gt;" baseObject 
9	22.799119	192.168.17.144	192.168.17.145	TCP	1514	389 → 57855 [ACK] Seq=1 Ack=351 Win=2102272 Len=1460 [TCP segment of a reassembled PDU]
10	22.799128	192.168.17.144	192.168.17.145	LDAP	1345	searchResEntry(1) "&lt;ROOT&gt;"  | searchResDone(1) success  [1 result]
</pre>

<p>
Looks like more traffic is generated but starts with the traditional SYN SYN,ACK ACK handshake that then dives into LDAP which lives encapsulated within TCP (so layer 5?) where it request
</p>

<div class="org-src-container">
<pre class="src src-ldap">LDAPMessage searchRequest(1) "&lt;ROOT&gt;" baseObject
</pre>
</div>

<p>
From the ldapwiki.com <a href="https://ldapwiki.com/wiki/BaseObject">https://ldapwiki.com/wiki/BaseObject</a>
"BaseObject is a specification for <a href="https://ldapwiki.com/wiki/LDAP%20Search%20Scopes">LDAP Search Scopes</a> that specifies that the <a href="https://ldapwiki.com/wiki/SearchRequest">Search Request</a> should only be performed against the <a href="https://ldapwiki.com/wiki/LDAP%20Entry">entry</a> specified as the search <a href="https://ldapwiki.com/wiki/BaseDN">Base DN</a>." 
But this returns the domain rather quickly in the 10 packet after the TCP handshake THEN LDAP request
</p>


<div id="org19e9684" class="figure">
<p><img src="../img/2022-05-WiresharkLDAPforAD.png" alt="2022-05-WiresharkLDAPforAD.png" />
</p>
</div>

<p>
but it goes on to create 312 more packets. With an LDAP authentication right after the answer is given.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-05-25</p>
<p class="author">Author: Russell Brinson</p>
<p class="date">Created: 2022-12-09 Fri 00:17</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
